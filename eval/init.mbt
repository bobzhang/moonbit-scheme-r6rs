///|
let primitive_bindings : Array[(String, @core.Primitive)] = [
  ("+", @core.Primitive::Add),
  ("-", @core.Primitive::Sub),
  ("*", @core.Primitive::Mul),
  ("/", @core.Primitive::Div),
  ("=", @core.Primitive::NumEq),
  ("<", @core.Primitive::Less),
  (">", @core.Primitive::Greater),
  ("<=", @core.Primitive::LessEq),
  (">=", @core.Primitive::GreaterEq),
  ("cons", @core.Primitive::Cons),
  ("car", @core.Primitive::Car),
  ("cdr", @core.Primitive::Cdr),
  ("list", @core.Primitive::List),
  ("make-list", @core.Primitive::MakeList),
  ("null?", @core.Primitive::NullP),
  ("pair?", @core.Primitive::PairP),
  ("symbol?", @core.Primitive::SymbolP),
  ("symbol=?", @core.Primitive::SymbolEq),
  ("identifier?", @core.Primitive::IdentifierP),
  ("syntax?", @core.Primitive::SyntaxP),
  ("free-identifier=?", @core.Primitive::FreeIdentifierEq),
  ("bound-identifier=?", @core.Primitive::BoundIdentifierEq),
  ("symbol->string", @core.Primitive::SymbolToString),
  ("string->symbol", @core.Primitive::StringToSymbol),
  ("string-hash", @core.Primitive::StringHash),
  ("string-ci-hash", @core.Primitive::StringCiHash),
  ("symbol-hash", @core.Primitive::SymbolHash),
  ("equal-hash", @core.Primitive::EqualHash),
  ("syntax->datum", @core.Primitive::SyntaxToDatum),
  ("datum->syntax", @core.Primitive::DatumToSyntax),
  ("make-variable-transformer", @core.Primitive::MakeVariableTransformer),
  ("generate-temporaries", @core.Primitive::GenerateTemporaries),
  ("boolean?", @core.Primitive::BooleanP),
  ("boolean=?", @core.Primitive::BooleanEq),
  ("number?", @core.Primitive::NumberP),
  ("integer?", @core.Primitive::IntegerP),
  ("exact-integer?", @core.Primitive::ExactIntegerP),
  ("rational?", @core.Primitive::RationalP),
  ("real?", @core.Primitive::RealP),
  ("complex?", @core.Primitive::ComplexP),
  ("exact?", @core.Primitive::ExactP),
  ("inexact?", @core.Primitive::InexactP),
  ("zero?", @core.Primitive::ZeroP),
  ("positive?", @core.Primitive::PositiveP),
  ("negative?", @core.Primitive::NegativeP),
  ("odd?", @core.Primitive::OddP),
  ("even?", @core.Primitive::EvenP),
  ("finite?", @core.Primitive::FiniteP),
  ("infinite?", @core.Primitive::InfiniteP),
  ("nan?", @core.Primitive::NanP),
  ("procedure?", @core.Primitive::ProcedureP),
  ("record?", @core.Primitive::RecordP),
  ("record-rtd", @core.Primitive::RecordRtd),
  ("record-type-descriptor?", @core.Primitive::RecordTypeDescriptorP),
  (
    "record-constructor-descriptor?",
    @core.Primitive::RecordConstructorDescriptorP,
  ),
  ("record-type-name", @core.Primitive::RecordTypeName),
  ("record-type-parent", @core.Primitive::RecordTypeParent),
  ("record-type-uid", @core.Primitive::RecordTypeUid),
  ("record-type-generative?", @core.Primitive::RecordTypeGenerativeP),
  ("record-type-sealed?", @core.Primitive::RecordTypeSealedP),
  ("record-type-opaque?", @core.Primitive::RecordTypeOpaqueP),
  ("record-type-field-names", @core.Primitive::RecordTypeFieldNames),
  ("record-type-field-mutable?", @core.Primitive::RecordTypeFieldMutableP),
  (
    "record-constructor-descriptor",
    @core.Primitive::RecordConstructorDescriptor,
  ),
  ("record-constructor", @core.Primitive::RecordConstructor),
  ("record-predicate", @core.Primitive::RecordPredicate),
  ("record-accessor", @core.Primitive::RecordAccessor),
  ("record-mutator", @core.Primitive::RecordMutator),
  ("make-record-type-descriptor", @core.Primitive::MakeRecordTypeDescriptor),
  (
    "make-record-constructor-descriptor",
    @core.Primitive::MakeRecordConstructorDescriptor,
  ),
  ("condition", @core.Primitive::Condition),
  ("condition?", @core.Primitive::ConditionP),
  ("simple-conditions", @core.Primitive::SimpleConditions),
  ("condition-predicate", @core.Primitive::ConditionPredicate),
  ("condition-accessor", @core.Primitive::ConditionAccessor),
  ("make-eq-hashtable", @core.Primitive::MakeEqHashtable),
  ("make-eqv-hashtable", @core.Primitive::MakeEqvHashtable),
  ("make-hashtable", @core.Primitive::MakeHashtable),
  ("hashtable?", @core.Primitive::HashtableP),
  ("hashtable-size", @core.Primitive::HashtableSize),
  ("hashtable-ref", @core.Primitive::HashtableRef),
  ("hashtable-set!", @core.Primitive::HashtableSet),
  ("hashtable-delete!", @core.Primitive::HashtableDelete),
  ("hashtable-contains?", @core.Primitive::HashtableContainsP),
  ("hashtable-update!", @core.Primitive::HashtableUpdate),
  ("hashtable-copy", @core.Primitive::HashtableCopy),
  ("hashtable-clear!", @core.Primitive::HashtableClear),
  ("hashtable-keys", @core.Primitive::HashtableKeys),
  ("hashtable-entries", @core.Primitive::HashtableEntries),
  (
    "hashtable-equivalence-function",
    @core.Primitive::HashtableEquivalenceFunction,
  ),
  ("hashtable-hash-function", @core.Primitive::HashtableHashFunction),
  ("hashtable-mutable?", @core.Primitive::HashtableMutableP),
  ("make-enumeration", @core.Primitive::MakeEnumeration),
  ("enum-set-universe", @core.Primitive::EnumSetUniverse),
  ("enum-set-indexer", @core.Primitive::EnumSetIndexer),
  ("enum-set-constructor", @core.Primitive::EnumSetConstructor),
  ("enum-set?", @core.Primitive::EnumSetP),
  ("enum-set-member?", @core.Primitive::EnumSetMemberP),
  ("enum-set-subset?", @core.Primitive::EnumSetSubsetP),
  ("enum-set=?", @core.Primitive::EnumSetEq),
  ("enum-set-union", @core.Primitive::EnumSetUnion),
  ("enum-set-intersection", @core.Primitive::EnumSetIntersection),
  ("enum-set-difference", @core.Primitive::EnumSetDifference),
  ("enum-set-complement", @core.Primitive::EnumSetComplement),
  ("enum-set-projection", @core.Primitive::EnumSetProjection),
  ("enum-set->list", @core.Primitive::EnumSetToList),
  ("not", @core.Primitive::Not),
  ("apply", @core.Primitive::Apply),
  ("values", @core.Primitive::Values),
  ("call-with-values", @core.Primitive::CallWithValues),
  ("make-parameter", @core.Primitive::MakeParameter),
  ("dynamic-wind", @core.Primitive::DynamicWind),
  ("promise?", @core.Primitive::PromiseP),
  ("make-promise", @core.Primitive::MakePromise),
  ("force", @core.Primitive::Force),
  ("exact->inexact", @core.Primitive::ExactToInexact),
  ("inexact->exact", @core.Primitive::InexactToExact),
  ("exact-integer-sqrt", @core.Primitive::ExactIntegerSqrt),
  ("rationalize", @core.Primitive::Rationalize),
  ("number->string", @core.Primitive::NumberToString),
  ("string->number", @core.Primitive::StringToNumber),
  ("make-rectangular", @core.Primitive::MakeRectangular),
  ("make-polar", @core.Primitive::MakePolar),
  ("real-part", @core.Primitive::RealPart),
  ("imag-part", @core.Primitive::ImagPart),
  ("magnitude", @core.Primitive::Magnitude),
  ("angle", @core.Primitive::Angle),
  ("sqrt", @core.Primitive::Sqrt),
  ("exp", @core.Primitive::Exp),
  ("log", @core.Primitive::Log),
  ("expt", @core.Primitive::Expt),
  ("sin", @core.Primitive::Sin),
  ("cos", @core.Primitive::Cos),
  ("tan", @core.Primitive::Tan),
  ("asin", @core.Primitive::Asin),
  ("acos", @core.Primitive::Acos),
  ("atan", @core.Primitive::Atan),
  ("numerator", @core.Primitive::Numerator),
  ("denominator", @core.Primitive::Denominator),
  ("abs", @core.Primitive::Abs),
  ("quotient", @core.Primitive::Quotient),
  ("remainder", @core.Primitive::Remainder),
  ("modulo", @core.Primitive::Modulo),
  ("gcd", @core.Primitive::Gcd),
  ("lcm", @core.Primitive::Lcm),
  ("max", @core.Primitive::Max),
  ("min", @core.Primitive::Min),
  ("floor", @core.Primitive::Floor),
  ("ceiling", @core.Primitive::Ceiling),
  ("truncate", @core.Primitive::Truncate),
  ("round", @core.Primitive::Round),
  ("bitwise-and", @core.Primitive::BitwiseAnd),
  ("bitwise-ior", @core.Primitive::BitwiseIor),
  ("bitwise-xor", @core.Primitive::BitwiseXor),
  ("bitwise-not", @core.Primitive::BitwiseNot),
  ("bitwise-if", @core.Primitive::BitwiseIf),
  ("arithmetic-shift", @core.Primitive::ArithmeticShift),
  ("bitwise-bit-count", @core.Primitive::BitwiseBitCount),
  ("bitwise-length", @core.Primitive::BitwiseLength),
  ("bitwise-first-bit-set", @core.Primitive::BitwiseFirstBitSet),
  ("bitwise-bit-set?", @core.Primitive::BitwiseBitSetP),
  ("bitwise-copy-bit", @core.Primitive::BitwiseCopyBit),
  ("bitwise-bit-field", @core.Primitive::BitwiseBitField),
  ("bitwise-copy-bit-field", @core.Primitive::BitwiseCopyBitField),
  ("bitwise-rotate-bit-field", @core.Primitive::BitwiseRotateBitField),
  ("bitwise-reverse-bit-field", @core.Primitive::BitwiseReverseBitField),
  ("fixnum?", @core.Primitive::FixnumP),
  ("fixnum-width", @core.Primitive::FixnumWidth),
  ("least-fixnum", @core.Primitive::LeastFixnum),
  ("greatest-fixnum", @core.Primitive::GreatestFixnum),
  ("fx=?", @core.Primitive::FxEq),
  ("fx<?", @core.Primitive::FxLess),
  ("fx>?", @core.Primitive::FxGreater),
  ("fx<=?", @core.Primitive::FxLessEq),
  ("fx>=?", @core.Primitive::FxGreaterEq),
  ("fxzero?", @core.Primitive::FxZeroP),
  ("fxpositive?", @core.Primitive::FxPositiveP),
  ("fxnegative?", @core.Primitive::FxNegativeP),
  ("fxodd?", @core.Primitive::FxOddP),
  ("fxeven?", @core.Primitive::FxEvenP),
  ("fxmin", @core.Primitive::FxMin),
  ("fxmax", @core.Primitive::FxMax),
  ("fx+", @core.Primitive::FxAdd),
  ("fx-", @core.Primitive::FxSub),
  ("fx*", @core.Primitive::FxMul),
  ("fxdiv", @core.Primitive::FxDiv),
  ("fxmod", @core.Primitive::FxMod),
  ("fxdiv0", @core.Primitive::FxDiv0),
  ("fxmod0", @core.Primitive::FxMod0),
  ("fx+/carry", @core.Primitive::FxAddCarry),
  ("fx-/carry", @core.Primitive::FxSubCarry),
  ("fx*/carry", @core.Primitive::FxMulCarry),
  ("fxnot", @core.Primitive::FxNot),
  ("fxand", @core.Primitive::FxAnd),
  ("fxior", @core.Primitive::FxIor),
  ("fxxor", @core.Primitive::FxXor),
  ("fxif", @core.Primitive::FxIf),
  ("fxbit-count", @core.Primitive::FxBitCount),
  ("fxlength", @core.Primitive::FxLength),
  ("fxfirst-bit-set", @core.Primitive::FxFirstBitSet),
  ("fxbit-set?", @core.Primitive::FxBitSetP),
  ("fxcopy-bit", @core.Primitive::FxCopyBit),
  ("fxbit-field", @core.Primitive::FxBitField),
  ("fxcopy-bit-field", @core.Primitive::FxCopyBitField),
  ("fxrotate-bit-field", @core.Primitive::FxRotateBitField),
  ("fxreverse-bit-field", @core.Primitive::FxReverseBitField),
  ("fxarithmetic-shift", @core.Primitive::FxArithmeticShift),
  ("fxarithmetic-shift-left", @core.Primitive::FxArithmeticShiftLeft),
  ("fxarithmetic-shift-right", @core.Primitive::FxArithmeticShiftRight),
  ("flonum?", @core.Primitive::FlonumP),
  ("real->flonum", @core.Primitive::RealToFlonum),
  ("fixnum->flonum", @core.Primitive::FixnumToFlonum),
  ("fl=?", @core.Primitive::FlEq),
  ("fl<?", @core.Primitive::FlLess),
  ("fl>?", @core.Primitive::FlGreater),
  ("fl<=?", @core.Primitive::FlLessEq),
  ("fl>=?", @core.Primitive::FlGreaterEq),
  ("flinteger?", @core.Primitive::FlIntegerP),
  ("flzero?", @core.Primitive::FlZeroP),
  ("flpositive?", @core.Primitive::FlPositiveP),
  ("flnegative?", @core.Primitive::FlNegativeP),
  ("flodd?", @core.Primitive::FlOddP),
  ("fleven?", @core.Primitive::FlEvenP),
  ("flfinite?", @core.Primitive::FlFiniteP),
  ("flinfinite?", @core.Primitive::FlInfiniteP),
  ("flnan?", @core.Primitive::FlNanP),
  ("flmax", @core.Primitive::FlMax),
  ("flmin", @core.Primitive::FlMin),
  ("fl+", @core.Primitive::FlAdd),
  ("fl*", @core.Primitive::FlMul),
  ("fl-", @core.Primitive::FlSub),
  ("fl/", @core.Primitive::FlDiv),
  ("flabs", @core.Primitive::FlAbs),
  ("fldiv-and-mod", @core.Primitive::FlDivAndMod),
  ("fldiv", @core.Primitive::FlDivInt),
  ("flmod", @core.Primitive::FlMod),
  ("fldiv0-and-mod0", @core.Primitive::FlDiv0AndMod0),
  ("fldiv0", @core.Primitive::FlDiv0),
  ("flmod0", @core.Primitive::FlMod0),
  ("flnumerator", @core.Primitive::FlNumerator),
  ("fldenominator", @core.Primitive::FlDenominator),
  ("flfloor", @core.Primitive::FlFloor),
  ("flceiling", @core.Primitive::FlCeiling),
  ("fltruncate", @core.Primitive::FlTruncate),
  ("flround", @core.Primitive::FlRound),
  ("flexp", @core.Primitive::FlExp),
  ("fllog", @core.Primitive::FlLog),
  ("flsin", @core.Primitive::FlSin),
  ("flcos", @core.Primitive::FlCos),
  ("fltan", @core.Primitive::FlTan),
  ("flasin", @core.Primitive::FlAsin),
  ("flacos", @core.Primitive::FlAcos),
  ("flatan", @core.Primitive::FlAtan),
  ("flsqrt", @core.Primitive::FlSqrt),
  ("flexpt", @core.Primitive::FlExpt),
  ("eq?", @core.Primitive::Eq),
  ("eqv?", @core.Primitive::Eqv),
  ("equal?", @core.Primitive::Equal),
  ("list?", @core.Primitive::ListP),
  ("list-ref", @core.Primitive::ListRef),
  ("list-tail", @core.Primitive::ListTail),
  ("member", @core.Primitive::Member),
  ("memq", @core.Primitive::Memq),
  ("memv", @core.Primitive::Memv),
  ("assoc", @core.Primitive::Assoc),
  ("assq", @core.Primitive::Assq),
  ("assv", @core.Primitive::Assv),
  ("map", @core.Primitive::Map),
  ("for-each", @core.Primitive::ForEach),
  ("set-car!", @core.Primitive::SetCar),
  ("set-cdr!", @core.Primitive::SetCdr),
  ("list-copy", @core.Primitive::ListCopy),
  ("length", @core.Primitive::Length),
  ("append", @core.Primitive::Append),
  ("reverse", @core.Primitive::Reverse),
  ("char=?", @core.Primitive::CharEq),
  ("char<?", @core.Primitive::CharLess),
  ("char>?", @core.Primitive::CharGreater),
  ("char<=?", @core.Primitive::CharLessEq),
  ("char>=?", @core.Primitive::CharGreaterEq),
  ("char-ci=?", @core.Primitive::CharCiEq),
  ("char-ci<?", @core.Primitive::CharCiLess),
  ("char-ci>?", @core.Primitive::CharCiGreater),
  ("char-ci<=?", @core.Primitive::CharCiLessEq),
  ("char-ci>=?", @core.Primitive::CharCiGreaterEq),
  ("char?", @core.Primitive::CharP),
  ("char->integer", @core.Primitive::CharToInteger),
  ("integer->char", @core.Primitive::IntegerToChar),
  ("char-alphabetic?", @core.Primitive::CharAlphabeticP),
  ("char-numeric?", @core.Primitive::CharNumericP),
  ("char-whitespace?", @core.Primitive::CharWhitespaceP),
  ("char-upper-case?", @core.Primitive::CharUpperCaseP),
  ("char-lower-case?", @core.Primitive::CharLowerCaseP),
  ("char-upcase", @core.Primitive::CharUpcase),
  ("char-downcase", @core.Primitive::CharDowncase),
  ("char-foldcase", @core.Primitive::CharFoldcase),
  ("char-general-category", @core.Primitive::CharGeneralCategory),
  ("string=?", @core.Primitive::StringEq),
  ("string<?", @core.Primitive::StringLess),
  ("string>?", @core.Primitive::StringGreater),
  ("string<=?", @core.Primitive::StringLessEq),
  ("string>=?", @core.Primitive::StringGreaterEq),
  ("string-ci=?", @core.Primitive::StringCiEq),
  ("string-ci<?", @core.Primitive::StringCiLess),
  ("string-ci>?", @core.Primitive::StringCiGreater),
  ("string-ci<=?", @core.Primitive::StringCiLessEq),
  ("string-ci>=?", @core.Primitive::StringCiGreaterEq),
  ("string", @core.Primitive::String),
  ("make-string", @core.Primitive::MakeString),
  ("string?", @core.Primitive::StringP),
  ("string-length", @core.Primitive::StringLength),
  ("string-append", @core.Primitive::StringAppend),
  ("string-ref", @core.Primitive::StringRef),
  ("string-set!", @core.Primitive::StringSet),
  ("string-copy", @core.Primitive::StringCopy),
  ("substring", @core.Primitive::Substring),
  ("string-copy!", @core.Primitive::StringCopyBang),
  ("string-fill!", @core.Primitive::StringFill),
  ("string->list", @core.Primitive::StringToList),
  ("list->string", @core.Primitive::ListToString),
  ("string-map", @core.Primitive::StringMap),
  ("string-for-each", @core.Primitive::StringForEach),
  ("string-upcase", @core.Primitive::StringUpcase),
  ("string-downcase", @core.Primitive::StringDowncase),
  ("string-foldcase", @core.Primitive::StringFoldcase),
  ("string-normalize-nfc", @core.Primitive::StringNormalizeNfc),
  ("string-normalize-nfd", @core.Primitive::StringNormalizeNfd),
  ("string-normalize-nfkc", @core.Primitive::StringNormalizeNfkc),
  ("string-normalize-nfkd", @core.Primitive::StringNormalizeNfkd),
  ("vector", @core.Primitive::Vector),
  ("make-vector", @core.Primitive::MakeVector),
  ("vector?", @core.Primitive::VectorP),
  ("vector-length", @core.Primitive::VectorLength),
  ("vector-ref", @core.Primitive::VectorRef),
  ("vector-set!", @core.Primitive::VectorSet),
  ("vector-fill!", @core.Primitive::VectorFill),
  ("vector-copy", @core.Primitive::VectorCopy),
  ("vector-copy!", @core.Primitive::VectorCopyBang),
  ("vector-append", @core.Primitive::VectorAppend),
  ("vector-map", @core.Primitive::VectorMap),
  ("vector-for-each", @core.Primitive::VectorForEach),
  ("vector->list", @core.Primitive::VectorToList),
  ("list->vector", @core.Primitive::ListToVector),
  ("bytevector", @core.Primitive::ByteVector),
  ("make-bytevector", @core.Primitive::MakeByteVector),
  ("bytevector?", @core.Primitive::ByteVectorP),
  ("bytevector-length", @core.Primitive::ByteVectorLength),
  ("bytevector=?", @core.Primitive::ByteVectorEq),
  ("bytevector-u8-ref", @core.Primitive::ByteVectorU8Ref),
  ("bytevector-u8-set!", @core.Primitive::ByteVectorU8Set),
  ("bytevector-copy", @core.Primitive::ByteVectorCopy),
  ("bytevector-copy!", @core.Primitive::ByteVectorCopyBang),
  ("bytevector-append", @core.Primitive::ByteVectorAppend),
  ("bytevector-fill!", @core.Primitive::ByteVectorFill),
  ("bytevector->u8-list", @core.Primitive::ByteVectorToU8List),
  ("u8-list->bytevector", @core.Primitive::U8ListToByteVector),
  ("string->utf8", @core.Primitive::StringToUtf8),
  ("utf8->string", @core.Primitive::Utf8ToString),
  ("native-endianness", @core.Primitive::NativeEndianness),
  ("bytevector-uint-ref", @core.Primitive::ByteVectorUintRef),
  ("bytevector-sint-ref", @core.Primitive::ByteVectorSintRef),
  ("bytevector-uint-set!", @core.Primitive::ByteVectorUintSet),
  ("bytevector-sint-set!", @core.Primitive::ByteVectorSintSet),
  ("display", @core.Primitive::Display),
  ("write", @core.Primitive::Write),
  ("newline", @core.Primitive::Newline),
  ("open-output-string", @core.Primitive::OpenOutputString),
  ("get-output-string", @core.Primitive::GetOutputString),
  ("current-output-port", @core.Primitive::CurrentOutputPort),
  ("with-exception-handler", @core.Primitive::WithExceptionHandler),
  ("raise", @core.Primitive::Raise),
  ("raise-continuable", @core.Primitive::RaiseContinuable),
  ("error", @core.Primitive::Error),
  ("assertion-violation", @core.Primitive::AssertionViolation),
  (
    "implementation-restriction-violation",
    @core.Primitive::ImplementationRestrictionViolation,
  ),
  ("undefined-violation", @core.Primitive::UndefinedViolation),
  ("syntax-violation", @core.Primitive::SyntaxViolation),
  ("call/cc", @core.Primitive::CallCC),
  ("call-with-current-continuation", @core.Primitive::CallCC),
  ("eval", @core.Primitive::Eval),
  ("environment", @core.Primitive::Environment),
]

///|
let cxr_chains : Array[String] = [
  "aa", "ad", "da", "dd", "aaa", "aad", "ada", "add", "daa", "dad", "dda", "ddd",
  "aaaa", "aaad", "aada", "aadd", "adaa", "adad", "adda", "addd", "daaa", "daad",
  "dada", "dadd", "ddaa", "ddad", "ddda", "dddd",
]

///|
fn define_primitives(
  env : @core.Env,
  defs : Array[(String, @core.Primitive)],
) -> Unit {
  for i = 0; i < defs.length(); {
    // invariant : i >= 0 && i <= defs.length()
    // decreases : defs.length() - i
    // assert : i <= defs.length()
    let (name, prim) = defs[i]
    @runtime.env_define(env, name, @core.Value::Primitive(prim))
    continue i + 1
  } else {
    ()
  }
}

///|
fn define_cxr_primitives(env : @core.Env) -> Unit {
  for chain in cxr_chains {
    @runtime.env_define(
      env,
      "c\{chain}r",
      @core.Value::Primitive(@core.Primitive::Cxr(chain)),
    )
  }
}

///|
fn init_env() -> @core.Env {
  let env = @runtime.env_new()
  let condition_rtd = match
    @runtime.lookup_record_type_descriptor("&condition") {
    Some(desc) => desc
    None => {
      let condition_type = @runtime.make_record_type(
        "&condition",
        None,
        false,
        false,
        None,
        [],
      )
      let condition_ctor_desc = @runtime.make_record_constructor_descriptor(
        condition_type,
        None,
        None,
      )
      let condition_rtd = @runtime.make_record_type_descriptor(
        condition_type, condition_ctor_desc,
      )
      let _ = @runtime.register_record_type("&condition", condition_rtd)
      condition_rtd
    }
  }
  @runtime.env_define(
    env,
    "&condition",
    @core.Value::RecordTypeDescriptor(condition_rtd),
  )
  define_primitives(env, primitive_bindings)
  define_cxr_primitives(env)
  env
}

///|
fn env_export_map(env : @core.Env) -> Map[String, @core.Binding] {
  let exports : Map[String, @core.Binding] = {}
  for frame in env {
    frame.iter2().each((key, binding) => exports[key] = binding)
  }
  exports
}
